___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "CLIENT",
  "id": "cvt_temp_public_id",
  "categories": [
    "UTILITY"
  ],
  "__wm": "VGVtcGxhdGUtQXV0aG9yX0NhdGNoLWFsbC1DbGllbnQtU2ltby1BaGF2YQ\u003d\u003d",
  "version": 1,
  "securityGroups": [],
  "displayName": "Catch-all Client",
  "brand": {
    "id": "brand_dummy",
    "displayName": "",
    "thumbnail": "data:image/png;base64,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\u003d"
  },
  "description": "Use this Client to act as a fallback for requests that have no Client to claim them. You can set the status code and message in the Client settings. Remember to set the Priority to low (e.g. -1000).",
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "LABEL",
    "name": "info",
    "displayName": "Make sure you set the \u003cstrong\u003ePriority\u003c/strong\u003e value to a smaller number than any other client you are using (e.g. \u003cstrong\u003e-1000\u003c/strong\u003e) to ensure this fallback client doesn\u0027t claim a valid request."
  },
  {
    "type": "TEXT",
    "name": "statusCode",
    "displayName": "Status Code",
    "simpleValueType": true,
    "defaultValue": 404,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      },
      {
        "type": "REGEX",
        "args": [
          "^\\d{3}$"
        ],
        "errorMessage": "Must be a valid status code (e.g. 404)."
      }
    ],
    "alwaysInSummary": true
  },
  {
    "type": "TEXT",
    "name": "statusMessage",
    "displayName": "Status Message",
    "simpleValueType": true,
    "defaultValue": "No client claimed the request.",
    "alwaysInSummary": true
  },
  {
    "type": "TEXT",
    "name": "allowedOrigins",
    "displayName": "Allowed Origins",
    "simpleValueType": true,
    "valueHint": "https://www.mydomain.com,https://sub.mydomain.com",
    "help": "Set to a comma-separated list of origins (e.g. https://www.mydomain.com) from which HTTP requests are allowed. Set to \u003cstrong\u003e*\u003c/strong\u003e to allow from any origin.",
    "alwaysInSummary": true
  },
  {
    "type": "CHECKBOX",
    "name": "robots",
    "checkboxText": "Add \"noindex\" X-Robots-Tag Header To Response",
    "simpleValueType": true,
    "defaultValue": true,
    "help": "With this header in place, search engines will be discouraged from indexing the requested resource."
  }
]


___SANDBOXED_JS_FOR_SERVER___

const claimRequest = require('claimRequest');
const getRequestHeader = require('getRequestHeader');
const getRequestPath = require('getRequestPath');
const makeNumber = require('makeNumber');
const returnResponse = require('returnResponse');
const setResponseBody = require('setResponseBody');
const setResponseHeader = require('setResponseHeader');
const setResponseStatus = require('setResponseStatus');

claimRequest();
const origin = getRequestHeader('origin');
if (data.allowedOrigins === '*') {
  setResponseHeader('Access-Control-Allow-Origin', origin);
} else {
  data.allowedOrigins.split(',').forEach(o => setResponseHeader('Access-Control-Allow-Origin', o));
}
setResponseHeader('Access-Control-Allow-Credentials', 'true');
if (data.robots) setResponseHeader('X-Robots-Tag', 'noindex');

setResponseStatus(makeNumber(data.statusCode));
setResponseBody(data.statusMessage);

returnResponse();


___SERVER_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "return_response",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_response",
        "versionId": "1"
      },
      "param": [
        {
          "key": "writeResponseAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "writeStatusAllowed",
          "value": {
            "type": 8,
            "boolean": true
          }
        },
        {
          "key": "writeHeaderAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "writeBodyAllowed",
          "value": {
            "type": 8,
            "boolean": true
          }
        },
        {
          "key": "writeHeadersAllowed",
          "value": {
            "type": 8,
            "boolean": true
          }
        },
        {
          "key": "writeHeaderWhitelist",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "headerName"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "Access-Control-Allow-Origin"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "headerName"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "Access-Control-Allow-Credentials"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "headerName"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "X-Robots-Tag"
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_request",
        "versionId": "1"
      },
      "param": [
        {
          "key": "headerWhitelist",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "headerName"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "origin"
                  }
                ]
              }
            ]
          }
        },
        {
          "key": "headersAllowed",
          "value": {
            "type": 8,
            "boolean": true
          }
        },
        {
          "key": "pathAllowed",
          "value": {
            "type": 8,
            "boolean": true
          }
        },
        {
          "key": "requestAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "headerAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "queryParameterAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: Runs with * allowedOrigins
  code: |-
    // Call runCode to run the template's code.
    runCode(mockData);

    assertApi('claimRequest').wasCalled();
    assertApi('getRequestHeader').wasCalledWith('origin');
    assertApi('setResponseHeader').wasCalledWith('Access-Control-Allow-Origin', 'https://allow.com');
    assertApi('setResponseHeader').wasCalledWith('Access-Control-Allow-Credentials', 'true');
    assertApi('setResponseStatus').wasCalledWith(404);
    assertApi('setResponseBody').wasCalledWith('test');
    assertApi('returnResponse').wasCalled();
- name: Runs with set allowedOrigins
  code: |-
    mockData.allowedOrigins = 'https://allow1.com,https://allow2.com';

    // Call runCode to run the template's code.
    runCode(mockData);

    assertApi('claimRequest').wasCalled();
    assertApi('getRequestHeader').wasCalledWith('origin');
    assertApi('setResponseHeader').wasCalledWith('Access-Control-Allow-Origin', 'https://allow1.com');
    assertApi('setResponseHeader').wasCalledWith('Access-Control-Allow-Origin', 'https://allow2.com');
    assertApi('setResponseHeader').wasCalledWith('Access-Control-Allow-Credentials', 'true');
    assertApi('setResponseStatus').wasCalledWith(404);
    assertApi('setResponseBody').wasCalledWith('test');
    assertApi('returnResponse').wasCalled();
setup: "const mockData = {\n  statusCode: '404',\n  statusMessage: 'test',\n  allowedOrigins:\
  \ '*'\n};\n\nmock('getRequestHeader', header => {\n  if (header === 'origin') {\n\
  \    return 'https://allow.com';\n  } else { \n    fail('getRequestHeader() called\
  \ with something other than \"origin\".'); \n  }\n});\n\n\n  "


___NOTES___

Created on 28/10/2020, 13:00:18


